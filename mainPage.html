<!DOCTYPE html>
<html>
<head><title>Front Page</title>
	<link rel="stylesheet" type="text/css" href="chatroom.css"/>
	<link rel="stylesheet" href="spectrum.css" />
	<script src="/socket.io/socket.io.js"></script>
	<script src="http://code.jquery.com/jquery-1.11.1.min.js"></script>
	<script src="http://code.jquery.com/ui/1.11.1/jquery-ui.min.js"></script>
	<script type = "text/javascript" src="http://bgrins.github.com/spectrum/spectrum.js"></script>
	<script>
		var socketio = io.connect(); //connects to socket 
		var tempMessage = "";
		var color2;
		socketio.on('connect', function(){ //when it connects, ask for username
			// call the server-side function 'adduser' and send one parameter (value of prompt)
			socketio.emit('adduser', prompt("What's your username?"));
			document.getElementById("createRoomForm").style.visibility = "visible"; 
		});
		socketio.on('reprompt', function(message){ //asks for username again 
			console.log("reprompt triggered"); 
			socketio.emit('adduser', prompt(message + " please re-enter username"));
		});
		socketio.on('usageMessage', function(message){ //alert message
			alert(message);
		});


		//message handlers------------------------------------------------------------------------------------------------------------
		socketio.on("message_to_client",function(username, data) {
			tempMessage = username + ": " + data["message"];
			socketio.emit('roomCreator', username);
		});
		socketio.on("roomCreatorRes", function(creator, username) {
			var node = document.createElement("tr");
			var node2 = document.createElement("td");
			node2.setAttribute("class", "color");
			node2.textContent = tempMessage;
			console.log("userDialogue inserted");
			node2.addEventListener("dblclick", function(){
				console.log("double clicked");
				$("#userDialogue").dialog({
					autoOpen: false,
					show: false,
					resizable: true,
					position: 'center',
					stack: true,
					height: 80,
					width: 300,
					title: "action on " + username,
					modal: false
				});
				$("#userDialogue").data("username", username);
				$("#userDialogue").dialog('open');
			}, false);
			if (creator) {
				document.getElementById("kickUser").style.visibility = "visible";
			}
			else {
				document.getElementById("kickUser").style.visibility = "hidden";
			}
			node.appendChild(node2);
			document.getElementById("chatMessages").appendChild(node);
		});
		socketio.on('serverMessage', function(chatName, message){
			var node = document.createElement("tr");
			var node2 = document.createElement("td");
			node.setAttribute("id", chatName);
			node2.textContent = message;
			node.appendChild(node2);
			document.getElementById("chatMessages").appendChild(node);
		});
		socketio.on("prv_message_to_client",function(username, data) {
			var node = document.createElement("tr");
			var node2 = document.createElement("td");
			node2.textContent = username + ": " + data["message"];
			node.appendChild(node2);
			document.getElementById("prvChatMessages").appendChild(node);
		});



		//chatroom handlers--------------------------------------------------------------------------------------------------------------
		socketio.on('updateRooms', function(chatrooms){
			while (document.getElementById("allChats").childNodes.length > 2){
				document.getElementById("allChats").removeChild(document.getElementById("allChats").lastChild);
			}
			Object.keys(chatrooms).forEach(function(room){
				var chatName = String(room);
				var node = document.createElement("tr"); //puts all chatnames in a table
				var node2 = document.createElement("td");
				node.setAttribute("id", chatName);
				node2.textContent = chatName + ", created by " + chatrooms[chatName].creator; //cell has chat name and the creator of chat
				if (chatrooms[chatName].password) { // if there is a password
					node2.textContent += " (protected)"; 
				}
				node.addEventListener("dblclick", function(){ 
					socketio.emit('switchRoom', chatName);
					while (document.getElementById("chatMessages").childNodes.length > 0){
						document.getElementById("chatMessages").removeChild(document.getElementById("chatMessages").lastChild);
					}
					$("#divdeps").dialog({
						autoOpen: false,
						show: false,
						resizable: true,
						position: 'center',
						stack: true,
						height: 500,
						width: 500,
						title: chatName,
						modal: false
					});
					$("#divdeps").dialog('open');
					$("#custom").spectrum({ //https://bgrins.github.io/spectrum/
					color: "#000000",
					change: function(color){ //when a new font color is selected
						//get color sent to serverMessage
						alert(color.toHexString());
						document.getElementById("chatMessages").style.color = color.toHexString();
						}
					});
					$("#message").keyup(function(event) {
						if (event.keyCode === 13) {
						$("#message").click();
							}
					});
				}, false);
				node.appendChild(node2);
				document.getElementById("allChats").appendChild(node);
			});
		});
		socketio.on("joinPrvChat",function(username, otherUser) {
			$("#prvMsgChat").dialog({
				autoOpen: false,
				show: false,
				resizable: true,
				position: 'center',
				stack: true,
				height: 400,
				width: 400,
				title: "private chat with " + username,
				modal: false
			});
			$("#prvMsgChat").dialog('open');
			socketio.emit('prvMsgConfirm', otherUser);
		});



		//password handers----------------------------------------------------------------------------------------------------------------
		socketio.on("passwordVerify",function(chatName) {
			socketio.emit('verifiedPassword', prompt("Enter Password: "), chatName);
		});



		//user action handlers-------------------------------------------------------------------------------------------------------------
		socketio.on("confirmKickUser", function() {
			console.log("user kicked");
			$("#divdeps").dialog('close');
			socketio.emit('kickUserServer');
		});
		socketio.on("confirmBanUser", function() {
			console.log("user banned");
			$("#divdeps").dialog('close');
			socketio.emit('banUserServer');
		});
		socketio.on("closeDialogue", function() {
			$("#divdeps").dialog('close');
		});

		//functions %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
		//message handlers------------------------------------------------------------------------------------------------------------------
		function sendMessage(){
			var msg = document.getElementById("message").value;
			socketio.emit("message_to_server", {message:msg});
			document.getElementById("message").value = '';
		}

		function sendPrvMessage() {
			var msg = document.getElementById("prvMessage").value;
			socketio.emit("prv_message_to_server", {message:msg});
			document.getElementById("message").value = '';
		}

		//room handers----------------------------------------------------------------------------------------------------------------------
		function addChat(){
			var chatName = document.getElementById("roomName").value;
			document.getElementById("roomName").value = "";
			socketio.emit('addChatroom', chatName);
		}

		function addProtectedChat(){
			var chatName = document.getElementById("roomName").value;
			document.getElementById("roomName").value = "";
			socketio.emit('addProtectedChatroom', prompt("Enter Password: "), chatName);
		}

		function prvMsg(username) {
			socketio.emit("prvMsg", username);
			$("#prvMsgChat").dialog({
				autoOpen: false,
				show: false,
				resizable: true,
				position: 'center',
				stack: true,
				height: 400,
				width: 400,
				title: "private chat with " + username,
				modal: false
			});
			$("#userDialogue").dialog('close');
			$("#prvMsgChat").dialog('open');
		}

		//user action handlers--------------------------------------------------------------------------------------------------------------
		function kickUser(username) {
			socketio.emit("kickUser", username);
			$("#userDialogue").dialog('close');
		}
		function banUser(username) {
			socketio.emit("banUser", username);
			$("#userDialogue").dialog('close');
		}
	</script>
</head>




<!-- html code for webpage %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%     -->
<body> 
	<!-- 	returning user login -->
	<div>
		<!-- form for creating new room %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%     -->
		<div id = "createRoomForm" style = "visibility: hidden"> 
			<h1> Create a Chat Room </h1>
			<p>Enter chatroom name: <input type = "text" class = "chatName" id = "roomName"/></p>
			<button type = "submit" value = "addChat" id = "addChat" onclick = "addChat();"> Create Chat Room</button>
			<button type = "submit" value = "addProtectedChat" id = "addProtectedChat" onclick = "addProtectedChat();"> Create Protected Chat Room</button>
		</div>
		
		<!-- table for existing chatrooms %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%   -->
		<br>
		<table id = "allChats" class = "chatTable" style = "visibility: visible">
			<tr>
				<th class = "chatTableHeader"> All Chat Rooms</th>
			</tr>
		</table>
		<!-- form for chat dialogue %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%          -->
		<div id="divdeps" style= "display:none" title = "Conversation Title" class = "divdeps">
			<div id = "chatlog"></div>
			<table id = "chatMessages" style = "visibility: visible"></table>
			<form class = "enterMessage">
				Enter Message: <input type='text' id="custom" class = "custom"/> <!--https://bgrins.github.io/spectrum/-->
				<textarea id="message" class = "message" cols="30" rows="5" onkeypress = "if (event.keyCode == 13) sendMessage();"></textarea>
			</form> 
			<button type = "submit" value = "send" id = "send1" onclick = "sendMessage();"> Send </button>
		</div>

		<!-- form for private chat dialogue %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%          -->
		<div id="prvMsgChat" style= "display:none" title = "Conversation Title" class = "prvMsgChat">
			<div id = "prvMsgChatlog"></div>
			<table id = "prvChatMessages" style = "visibility: visible"></table>
			<form class = "enterMessage">
				Enter Message: <textarea id="prvMessage" class = "prvMmessage" cols="30" rows="5" onkeypress = "if (event.keyCode == 13) sendMessage();"></textarea>
			</form> 
			<button type = "submit" value = "send" id = "send2" onclick = "sendPrvMessage();"> Send </button>
		</div>

		<!-- form for selecting what to do with selected user %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%       -->
		<div id="userDialogue" style= "display:none" title = "User" class = "userDialogue">
			<div id = "kickUser" style = "visibility: hidden">
				<button type = "submit" value = "kick" id = "kick" onclick = "kickUser($('#userDialogue').data('username'));"> Kick User </button>
				<button type = "submit" value = "ban" id = "ban" onclick = "banUser($('#userDialogue').data('username'));"> Ban User </button>
			</div>
			<button type = "submit" value = "prvMsg" id = "prvMsg" onclick = "prvMsg($('#userDialogue').data('username'));"> Message this user privately </button>
		</div>
	</div>
	
	<script>
	</script>
	
</body>
</html>