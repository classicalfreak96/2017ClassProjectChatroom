<!DOCTYPE html>
<html>
<head><title>Front Page</title>
	<link rel="stylesheet" type="text/css" href="chatroom.css"/>
	<script src="/socket.io/socket.io.js"></script>
	<script src="http://code.jquery.com/jquery-1.11.1.min.js"></script>
	<script src="http://code.jquery.com/ui/1.11.1/jquery-ui.min.js"></script>	
	<script> 

		var socketio = io.connect();
		socketio.on('connect', function(){
			// call the server-side function 'adduser' and send one parameter (value of prompt)
			socketio.emit('adduser', prompt("What's your username?"));
			document.getElementById("createRoomForm").style.visibility = "visible";
		});
		socketio.on("message_to_client",function(username, data) {
			//Append an HR thematic break and the escaped HTML of the new message
			console.log(username + " wrote " + data["message"]);
//			document.getElementById("chatlog").appendChild(document.createElement("hr"));
			var node = document.createElement("tr");
			var node2 = document.createElement("td");
			node2.textContent = username + ": " + data["message"];
			node2.addEventListener("dblclick", function(){
				console.log("double clicked");
				$("#userDialogue").dialog({
					autoOpen: false,
					show: false,
					resizable: true,
					position: 'center',
					stack: true,
					height: 50,
					width: 300,
					title: "action on" + username,
					modal: false
				});
				$("#userDialogue").dialog('open');
			}, false);
			node.appendChild(node2);
			document.getElementById("chatMessages").appendChild(node);
			//document.getElementById("chatlog").appendChild(document.createTextNode(username + ": " + data["message"]));
		});
		socketio.on("confirmAddChatroom", function(chatNameIn) {
			var chatName = chatNameIn;
			var node = document.createElement("tr");
			var node2 = document.createElement("td");
			node.setAttribute("class", chatName);
			node2.textContent = chatName;
			node.addEventListener("dblclick", function(){
				socketio.emit('switchRoom', chatName);
				$("#divdeps").dialog({
					autoOpen: false,
					show: false,
					resizable: true,
					position: 'center',
					stack: true,
					height: 500,
					width: 500,
					title: chatName,
					modal: false
				});
				$("#divdeps").dialog('open');
			}, false);
			node.appendChild(node2);
			document.getElementById("allChats").appendChild(node);
		});
		socketio.on('updateRooms', function(chatrooms){
				while (document.getElementById("allChats").childNodes.length > 2){
					document.getElementById("allChats").removeChild(document.getElementById("allChats").lastChild);
				}
				chatrooms.forEach(function(room){
					var chatName = room;
					var node = document.createElement("tr");
					var node2 = document.createElement("td");
					node.setAttribute("class", chatName);
					node2.textContent = chatName;
					node.addEventListener("dblclick", function(){
						socketio.emit('switchRoom', chatName);
						$("#divdeps").dialog({
							autoOpen: false,
							show: false,
							resizable: true,
							position: 'center',
							stack: true,
							height: 500,
							width: 500,
							title: chatName,
							modal: false
						});
						$("#divdeps").dialog('open');	
					}, false);
					node.appendChild(node2);
					document.getElementById("allChats").appendChild(node);
				});
		});
		socketio.on('usageMessage', function(message){
			alert(message);
		});

		function addChat(){
			var chatName = document.getElementById("roomName").value;
			socketio.emit('addChatroom', chatName);
		}
	
	function sendMessage(){
		var msg = document.getElementById("message").value;
		socketio.emit("message_to_server", {message:msg});
		document.getElementById("message").value = '';
	}

	function openUserDialogue() {
		console.log("clicked");
	}
</script>
</head>
<body> 
	<!-- 	returning user login -->
	<div id = "loginForm">
		<div id = "logoutForm" style = "visibility: hidden">
			<p>
				<button id="logout_btn" onclick = "logout(event);" visibility = "hidden">Log Out</button>
				<button id="delete_btn" onclick = "deleteAccount(event);">Delete Account</button>
			</p>
		</div>
		<div id = "createRoomForm" style = "visibility: hidden"> 
			Create a chat room:
			Enter chatroom name: <input type = "text" class = "chatName" id = "roomName"/>
			<button type = "submit" value = "addChat" id = "addChat" onclick = "addChat();"> Create Chat Room</button>
		</div>

		<table id = "allChats" style = "visibility: visible">
			<tr>
				<th> All Chat Rooms</th>
			</tr>
		</table>

		<div id="divdeps" style= "display:none" title = "Conversation Title" class = "divdeps">
			<div id = "chatlog"></div>
				<table id = "chatMessages" style = "visibility: visible">
				</table>
			<form class = "enterMessage">
				Enter Message: <textarea id="message" class = "message" cols="30" rows="5"></textarea>
			</form> 
			<button type = "submit" value = "send" id = "send" onclick = "sendMessage();"> Send </button>

		</div>
		<div id="userDialogue" style= "display:none" title = "User" class = "userDialogue">
			<div id = "kickUser"></div>
			<button type = "submit" value = "kick" id = "kick" onclick = "kickUser();"> Kick User </button>
			<button type = "submit" value = "ban" id = "ban" onclick = "banUser();"> Ban User </button>
		</div>
	</div>
	
	<script>
		
	</script>
	
</body>
</html>